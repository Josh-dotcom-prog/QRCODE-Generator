<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student ID ¬∑ QR Generator</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap"
    rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #f5f0e8;
      color: #0a0a0f;
      font-family: 'Space Mono', monospace;
      min-height: 100vh;
    }

    .hidden {
      display: none !important;
    }

    /* ‚ïê‚ïê GENERATOR MODE ‚ïê‚ïê */
    #generator-mode header {
      padding: 1.2rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #0a0a0f;
      color: #f5f0e8;
    }

    #generator-mode header h1 {
      font-family: 'Syne', sans-serif;
      font-weight: 800;
      font-size: 1.3rem;
    }

    #generator-mode header .badge {
      background: #c8423a;
      color: white;
      font-size: 0.62rem;
      padding: 0.2rem 0.6rem;
      letter-spacing: 0.1em;
      font-weight: 700;
    }

    .layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      min-height: calc(100vh - 58px);
    }

    @media (max-width: 768px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .form-panel {
      padding: 2rem;
      border-right: 2px solid #0a0a0f;
      overflow-y: auto;
    }

    .preview-panel {
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-y: auto;
    }

    .panel-title {
      font-family: 'Syne', sans-serif;
      font-size: 0.65rem;
      font-weight: 700;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: #c8423a;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .panel-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #c8423a;
      opacity: 0.3;
    }

    .field-group {
      margin-bottom: 0.9rem;
    }

    label {
      display: block;
      font-size: 0.62rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #555;
      margin-bottom: 0.35rem;
      font-weight: 700;
    }

    input {
      width: 100%;
      background: transparent;
      border: 1.5px solid #0a0a0f;
      color: #0a0a0f;
      font-family: 'Space Mono', monospace;
      font-size: 0.78rem;
      padding: 0.55rem 0.75rem;
      outline: none;
      transition: border-color 0.15s;
    }

    input:focus {
      border-color: #c8423a;
    }

    input[type="file"] {
      padding: 0.4rem 0.75rem;
      font-size: 0.7rem;
      cursor: pointer;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.7rem;
    }

    .section-divider {
      font-size: 0.58rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: #888;
      padding: 0.9rem 0 0.7rem;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      margin-top: 0.3rem;
    }

    /* Photo preview in form */
    .photo-preview-wrap {
      margin-top: 0.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    #photo-thumb {
      width: 70px;
      height: 85px;
      object-fit: cover;
      border: 1.5px solid #0a0a0f;
      display: none;
    }

    .photo-note {
      font-size: 0.58rem;
      color: #777;
      line-height: 1.6;
    }

    .generate-btn {
      width: 100%;
      background: #0a0a0f;
      color: #f5f0e8;
      border: none;
      font-family: 'Syne', sans-serif;
      font-size: 0.82rem;
      font-weight: 800;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 0.85rem;
      cursor: pointer;
      margin-top: 1.2rem;
      transition: background 0.15s;
    }

    .generate-btn:hover {
      background: #c8423a;
    }

    .generate-btn:disabled {
      background: #888;
      cursor: not-allowed;
    }

    .placeholder-msg {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      opacity: 0.3;
      padding: 4rem 1rem;
      text-align: center;
    }

    .placeholder-msg p {
      font-size: 0.72rem;
      letter-spacing: 0.06em;
      line-height: 1.7;
    }

    .mini-card {
      width: 100%;
      max-width: 320px;
      border: 2px solid #0a0a0f;
      background: white;
      box-shadow: 5px 5px 0 #0a0a0f;
    }

    .mini-card-header {
      background: #0a0a0f;
      color: #f5f0e8;
      padding: 0.75rem 1rem;
      text-align: center;
    }

    .mini-card-header .m-inst {
      font-family: 'Syne', sans-serif;
      font-size: 0.72rem;
      font-weight: 800;
      letter-spacing: 0.04em;
    }

    .mini-card-header .m-dept {
      font-size: 0.55rem;
      opacity: 0.6;
      margin-top: 0.1rem;
    }

    .mini-card-body {
      padding: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }

    .mini-name {
      font-family: 'Syne', sans-serif;
      font-size: 0.8rem;
      font-weight: 800;
      text-transform: uppercase;
      text-align: center;
    }

    #qr-display canvas,
    #qr-display img {
      max-width: 130px !important;
      height: auto !important;
    }

    .scan-hint {
      font-size: 0.52rem;
      opacity: 0.4;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      text-align: center;
    }

    .url-label {
      font-size: 0.58rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #777;
      margin-top: 1rem;
      width: 100%;
      max-width: 320px;
    }

    .url-box {
      width: 100%;
      max-width: 320px;
      background: #0a0a0f;
      color: #f5f0e8;
      padding: 0.65rem 0.9rem;
      font-size: 0.5rem;
      word-break: break-all;
      line-height: 1.6;
      opacity: 0.7;
      margin-top: 0.3rem;
      max-height: 80px;
      overflow: hidden;
    }

    .actions {
      margin-top: 1.2rem;
      display: flex;
      gap: 0.6rem;
      width: 100%;
      max-width: 320px;
    }

    .btn-outline {
      flex: 1;
      background: transparent;
      border: 2px solid #0a0a0f;
      color: #0a0a0f;
      font-family: 'Syne', sans-serif;
      font-size: 0.65rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      padding: 0.6rem;
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
    }

    .btn-outline:hover {
      background: #0a0a0f;
      color: #f5f0e8;
    }

    .warn-box {
      width: 100%;
      max-width: 320px;
      margin-top: 0.75rem;
      background: #fff8e1;
      border-left: 3px solid #f5a623;
      padding: 0.6rem 0.75rem;
      font-size: 0.58rem;
      line-height: 1.6;
      color: #555;
    }

    /* ‚ïê‚ïê DISPLAY MODE ‚Äî matches the image exactly ‚ïê‚ïê */
    #display-mode {
      display: none;
      min-height: 100vh;
      background: #fff;
      flex-direction: column;
      align-items: center;
      font-family: Arial, sans-serif;
    }

    .d-topbar {
      width: 100%;
      max-width: 480px;
      text-align: center;
      font-weight: bold;
      font-size: 0.95rem;
      color: #222;
      padding: 0.7rem 1rem;
      border-bottom: 1px solid #ddd;
    }

    .d-card {
      width: 100%;
      max-width: 480px;
      background: #fff;
    }

    .d-photo-area {
      display: flex;
      justify-content: center;
      padding: 2rem 1rem 1.2rem;
    }

    .d-photo-box {
      width: 200px;
      height: 240px;
      background: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #bbb;
      font-size: 0.75rem;
      overflow: hidden;
    }

    .d-photo-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .d-name-banner {
      background: #d6e8f0;
      text-align: center;
      padding: 0.65rem 1rem;
      font-size: 1rem;
      font-weight: bold;
      color: #111;
      margin: 0 1rem;
    }

    .d-rows {
      padding: 0.8rem 1rem 2rem;
    }

    .d-row {
      display: flex;
      align-items: flex-start;
      padding: 0.45rem 0;
      font-size: 0.92rem;
      color: #111;
      line-height: 1.45;
    }

    .d-label {
      width: 120px;
      flex-shrink: 0;
      color: #333;
      font-weight: normal;
    }

    .d-value {
      flex: 1;
      font-weight: bold;
      color: #000;
    }
  </style>
</head>

<body>

  <!-- ‚ïê‚ïê GENERATOR MODE ‚ïê‚ïê -->
  <div id="generator-mode">
    <header>
      <h1>Student ID ¬∑ QR Generator</h1>
      <div class="badge">QR ‚Üí Card</div>
    </header>

    <div class="layout">
      <div class="form-panel">
        <div class="panel-title">Student Information</div>

        <div class="field-group">
          <label>Full Name</label>
          <input type="text" id="f-name" placeholder="e.g. GUMANAMANI ANORLD" value="GUMANAMANI ANORLD">
        </div>
        <div class="grid-2">
          <div class="field-group">
            <label>Reg. No.</label>
            <input type="text" id="f-reg" value="2023/DEE/DAY/1244/G">
          </div>
          <div class="field-group">
            <label>Student No.</label>
            <input type="text" id="f-std" value="2301901244">
          </div>
        </div>
        <div class="field-group">
          <label>Institution</label>
          <input type="text" id="f-inst" value="Uganda Institute of ICT">
        </div>
        <div class="field-group">
          <label>Faculty / Department</label>
          <input type="text" id="f-faculty" value="Department of ICT and Engineering">
        </div>
        <div class="field-group">
          <label>Programme</label>
          <input type="text" id="f-prog" value="Diploma in Electrical & Electronics Engineering">
        </div>

        <div class="section-divider">Academic Details</div>

        <div class="grid-2">
          <div class="field-group">
            <label>CGPA</label>
            <input type="text" id="f-cgpa" value="3.93">
          </div>
          <div class="field-group">
            <label>Class</label>
            <input type="text" id="f-class" value="CLASS II (CREDIT)">
          </div>
        </div>
        <div class="field-group">
          <label>Year Completed</label>
          <input type="text" id="f-year" value="2024/2025">
        </div>
        <div class="field-group">
          <label>Transcript No. (optional)</label>
          <input type="text" id="f-transcript" placeholder="Leave blank if none">
        </div>

        <div class="section-divider">Student Photo</div>

        <div class="field-group">
          <label>Upload Photo</label>
          <input type="file" id="f-photo" accept="image/*" onchange="handlePhoto(this)">
          <div class="photo-preview-wrap">
            <img id="photo-thumb" alt="Preview">
            <div class="photo-note" id="photo-note">
              Photo will appear on the card when scanned.<br>
              Image is compressed automatically.
            </div>
          </div>
        </div>

        <button class="generate-btn" id="gen-btn" onclick="generate()">Generate QR Code</button>
        <div id="processing-msg" class="hidden"
          style="text-align:center;font-size:0.7rem;margin-top:0.5rem;opacity:0.6;">Processing image, please wait...
        </div>
      </div>

      <div class="preview-panel">
        <div class="panel-title">QR Code Preview</div>

        <div id="placeholder" class="placeholder-msg">
          <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="3" y="3" width="7" height="7" />
            <rect x="14" y="3" width="7" height="7" />
            <rect x="3" y="14" width="7" height="7" />
            <rect x="17" y="17" width="4" height="4" />
          </svg>
          <p>Fill in student details<br>and click Generate.<br><br>When scanned, the QR<br>opens a formatted student
            card.</p>
        </div>

        <div id="card-wrap" class="hidden">
          <div class="mini-card">
            <div class="mini-card-header">
              <div class="m-inst" id="c-inst">Institution</div>
              <div class="m-dept" id="c-faculty">Faculty</div>
            </div>
            <div class="mini-card-body">
              <div class="mini-name" id="c-name">NAME</div>
              <div id="qr-display"></div>
              <div class="scan-hint">Scan to view full ID card</div>
            </div>
          </div>

          <div id="warn-photo" class="warn-box hidden">
            ‚ö† Photo makes the QR very dense. If it doesn't scan, try a lower quality setting or remove the photo.
          </div>

          <div class="url-label">QR encodes this URL:</div>
          <div class="url-box" id="url-preview">‚Äî</div>

          <div class="actions">
            <button class="btn-outline" onclick="downloadQR()">‚Üì Download QR</button>
            <button class="btn-outline" onclick="previewCard()">üëÅ Preview Card</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê DISPLAY MODE ‚ïê‚ïê -->
  <div id="display-mode">
    <div class="d-topbar" id="d-topbar">Uganda Institute of ICT</div>

    <div class="d-card">
      <div class="d-photo-area">
        <div class="d-photo-box" id="d-photo-box">
          <span id="d-no-photo">No Photo</span>
        </div>
      </div>

      <div class="d-name-banner" id="d-name">STUDENT NAME</div>

      <div class="d-rows">
        <div class="d-row"><span class="d-label">RegNo.</span><span class="d-value" id="d-reg">‚Äî</span></div>
        <div class="d-row"><span class="d-label">StdNo.</span><span class="d-value" id="d-std">‚Äî</span></div>
        <div class="d-row"><span class="d-label">Faculty</span><span class="d-value" id="d-faculty">‚Äî</span></div>
        <div class="d-row"><span class="d-label">Programme</span><span class="d-value" id="d-prog">‚Äî</span></div>
        <div class="d-row"><span class="d-label">CGPA</span><span class="d-value" id="d-cgpa">‚Äî</span></div>
        <div class="d-row"><span class="d-label">CLASS</span><span class="d-value" id="d-class">‚Äî</span></div>
        <div class="d-row"><span class="d-label">Completed</span><span class="d-value" id="d-year">‚Äî</span></div>
        <div class="d-row" id="d-tr-trans" style="display:none">
          <span class="d-label">Transcript No.</span>
          <span class="d-value" id="d-transcript">‚Äî</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ‚îÄ‚îÄ Photo handling ‚îÄ‚îÄ
    let compressedPhotoData = null;

    function handlePhoto(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const img = new Image();
        img.onload = function () {
          // Show thumbnail in form
          const thumb = document.getElementById('photo-thumb');
          thumb.src = e.target.result;
          thumb.style.display = 'block';

          // Compress image to fit in URL (target ~60x75px, JPEG quality 0.5)
          const canvas = document.createElement('canvas');
          const MAX_W = 80, MAX_H = 100;
          let w = img.width, h = img.height;
          if (w / h > MAX_W / MAX_H) { w = MAX_W; h = Math.round(MAX_W * img.height / img.width); }
          else { h = MAX_H; w = Math.round(MAX_H * img.width / img.height); }
          canvas.width = w; canvas.height = h;
          canvas.getContext('2d').drawImage(img, 0, 0, w, h);

          // Try different quality levels until URL is manageable
          let quality = 0.5;
          let dataUrl = canvas.toDataURL('image/jpeg', quality);

          // Strip the data:image/jpeg;base64, prefix ‚Äî store only the base64
          compressedPhotoData = dataUrl.split(',')[1];

          const sizeKB = Math.round(compressedPhotoData.length * 0.75 / 1024);
          document.getElementById('photo-note').textContent =
            `Photo ready (${sizeKB}KB compressed). ${sizeKB > 100 ? 'Warning: may make QR hard to scan.' : 'Size is OK for QR.'}`;
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    // ‚îÄ‚îÄ If opened via QR scan ‚îÄ‚îÄ
    const params = new URLSearchParams(window.location.search);

    if (params.has('name')) {
      document.getElementById('generator-mode').style.display = 'none';
      document.getElementById('display-mode').style.display = 'flex';

      const get = (k) => params.get(k) ? decodeURIComponent(params.get(k)) : '‚Äî';

      document.getElementById('d-topbar').textContent = get('inst');
      document.getElementById('d-name').textContent = get('name');
      document.getElementById('d-reg').textContent = get('reg');
      document.getElementById('d-std').textContent = get('std');
      document.getElementById('d-faculty').textContent = get('faculty');
      document.getElementById('d-prog').textContent = get('prog');
      document.getElementById('d-cgpa').textContent = get('cgpa');
      document.getElementById('d-class').textContent = get('cls');
      document.getElementById('d-year').textContent = get('year');

      const trans = params.get('trans');
      if (trans && trans.trim() !== '') {
        document.getElementById('d-tr-trans').style.display = 'flex';
        document.getElementById('d-transcript').textContent = decodeURIComponent(trans);
      }

      // Load photo if present
      const photo = params.get('photo');
      if (photo && photo.trim() !== '') {
        const photoBox = document.getElementById('d-photo-box');
        document.getElementById('d-no-photo').style.display = 'none';
        const imgEl = document.createElement('img');
        imgEl.src = 'data:image/jpeg;base64,' + photo;
        imgEl.alt = get('name');
        photoBox.appendChild(imgEl);
      }

      document.title = get('name') + ' ¬∑ Student ID';
    }

    // ‚îÄ‚îÄ Generator ‚îÄ‚îÄ
    function buildURL(data) {
      const base = window.location.href.split('?')[0];
      const p = new URLSearchParams({
        name: data.name, reg: data.reg, std: data.std,
        inst: data.inst, faculty: data.faculty, prog: data.prog,
        cgpa: data.cgpa, cls: data.cls, year: data.year, trans: data.trans
      });
      if (data.photo) p.set('photo', data.photo);
      return base + '?' + p.toString();
    }

    function generate() {
      const data = {
        name: document.getElementById('f-name').value.trim() || 'STUDENT',
        reg: document.getElementById('f-reg').value.trim(),
        std: document.getElementById('f-std').value.trim(),
        inst: document.getElementById('f-inst').value.trim() || 'Institution',
        faculty: document.getElementById('f-faculty').value.trim(),
        prog: document.getElementById('f-prog').value.trim(),
        cgpa: document.getElementById('f-cgpa').value.trim(),
        cls: document.getElementById('f-class').value.trim(),
        year: document.getElementById('f-year').value.trim(),
        trans: document.getElementById('f-transcript').value.trim(),
        photo: compressedPhotoData || ''
      };

      const url = buildURL(data);

      document.getElementById('c-inst').textContent = data.inst;
      document.getElementById('c-faculty').textContent = data.faculty;
      document.getElementById('c-name').textContent = data.name;
      document.getElementById('url-preview').textContent = url.substring(0, 200) + (url.length > 200 ? '...' : '');

      const qrDiv = document.getElementById('qr-display');
      qrDiv.innerHTML = '';

      // Use lower error correction when photo is included to keep QR scannable
      const ecLevel = data.photo ? QRCode.CorrectLevel.L : QRCode.CorrectLevel.M;

      new QRCode(qrDiv, {
        text: url, width: 160, height: 160,
        colorDark: '#000000', colorLight: '#ffffff',
        correctLevel: ecLevel
      });

      // Warn if URL is very long
      if (url.length > 2000) {
        document.getElementById('warn-photo').classList.remove('hidden');
      } else {
        document.getElementById('warn-photo').classList.add('hidden');
      }

      document.getElementById('placeholder').classList.add('hidden');
      document.getElementById('card-wrap').classList.remove('hidden');
    }

    function downloadQR() {
      setTimeout(() => {
        const canvas = document.querySelector('#qr-display canvas');
        if (!canvas) { alert('Generate a QR code first.'); return; }
        const link = document.createElement('a');
        link.download = 'student-qr.png';
        link.href = canvas.toDataURL();
        link.click();
      }, 300);
    }

    function populateDisplayMode(p) {
      const get = (k) => p.get(k) ? decodeURIComponent(p.get(k)) : '‚Äî';
      document.getElementById('d-topbar').textContent = get('inst');
      document.getElementById('d-name').textContent = get('name');
      document.getElementById('d-reg').textContent = get('reg');
      document.getElementById('d-std').textContent = get('std');
      document.getElementById('d-faculty').textContent = get('faculty');
      document.getElementById('d-prog').textContent = get('prog');
      document.getElementById('d-cgpa').textContent = get('cgpa');
      document.getElementById('d-class').textContent = get('cls');
      document.getElementById('d-year').textContent = get('year');

      const trans = p.get('trans');
      if (trans && trans.trim() !== '') {
        document.getElementById('d-tr-trans').style.display = 'flex';
        document.getElementById('d-transcript').textContent = decodeURIComponent(trans);
      } else {
        document.getElementById('d-tr-trans').style.display = 'none';
      }

      // Photo
      const photo = p.get('photo');
      const photoBox = document.getElementById('d-photo-box');
      // Clear previous
      photoBox.innerHTML = '<span id="d-no-photo">No Photo</span>';
      if (photo && photo.trim() !== '') {
        document.getElementById('d-no-photo').style.display = 'none';
        const imgEl = document.createElement('img');
        imgEl.src = 'data:image/jpeg;base64,' + photo;
        imgEl.alt = get('name');
        photoBox.appendChild(imgEl);
      }
    }

    function previewCard() {
      const urlText = document.getElementById('url-preview').textContent;
      if (urlText === '‚Äî') { alert('Generate a QR code first.'); return; }

      // Rebuild full URL from stored data
      const data = {
        name: document.getElementById('f-name').value.trim() || 'STUDENT',
        reg: document.getElementById('f-reg').value.trim(),
        std: document.getElementById('f-std').value.trim(),
        inst: document.getElementById('f-inst').value.trim() || 'Institution',
        faculty: document.getElementById('f-faculty').value.trim(),
        prog: document.getElementById('f-prog').value.trim(),
        cgpa: document.getElementById('f-cgpa').value.trim(),
        cls: document.getElementById('f-class').value.trim(),
        year: document.getElementById('f-year').value.trim(),
        trans: document.getElementById('f-transcript').value.trim(),
        photo: compressedPhotoData || ''
      };

      const p = new URLSearchParams({
        name: data.name, reg: data.reg, std: data.std,
        inst: data.inst, faculty: data.faculty, prog: data.prog,
        cgpa: data.cgpa, cls: data.cls, year: data.year, trans: data.trans,
        photo: data.photo
      });

      populateDisplayMode(p);

      document.getElementById('generator-mode').style.display = 'none';
      const dm = document.getElementById('display-mode');
      dm.style.display = 'flex';

      if (!document.getElementById('back-btn')) {
        const btn = document.createElement('button');
        btn.id = 'back-btn';
        btn.textContent = '‚Üê Back to Generator';
        btn.style.cssText = 'margin:1.5rem auto;display:block;background:transparent;border:1px solid #aaa;color:#666;font-family:Arial,sans-serif;font-size:0.75rem;padding:0.5rem 1.2rem;cursor:pointer;';
        btn.onclick = () => {
          dm.style.display = 'none';
          document.getElementById('generator-mode').style.display = 'block';
          btn.remove();
        };
        dm.appendChild(btn);
      }
    }
  </script>
</body>

</html>